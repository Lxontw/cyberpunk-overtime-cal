<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OT Calc">
    
    <title>Overtime Calc v2.03</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        skin: {
                            base: 'var(--color-bg-base)',
                            card: 'var(--color-bg-card)',
                            input: 'var(--color-bg-input)',
                            text: 'var(--color-text-main)',
                            muted: 'var(--color-text-muted)',
                            accent: 'var(--color-accent)',
                            'accent-hover': 'var(--color-accent-hover)',
                            border: 'var(--color-border)',
                        }
                    },
                    fontFamily: {
                        main: 'var(--font-main)',
                        display: 'var(--font-display)',
                    },
                    borderRadius: {
                        theme: 'var(--radius-theme)',
                    },
                    boxShadow: {
                        theme: 'var(--shadow-theme)',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Theme Definitions --- */
        :root {
            /* Default: Cyberpunk */
            --color-bg-base: #050505;
            --color-bg-card: rgba(18, 18, 26, 0.95);
            --color-bg-input: #0a0a0f;
            --color-text-main: #e0e0e0;
            --color-text-muted: #6b7280;
            --color-accent: #00f3ff;
            --color-accent-hover: #0aff0a;
            --color-border: rgba(0, 243, 255, 0.3);
            --font-main: 'Rajdhani', sans-serif;
            --font-display: 'Orbitron', sans-serif;
            --radius-theme: 0px;
            --shadow-theme: 0 0 15px rgba(0, 243, 255, 0.15);
            --clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
            --bg-pattern: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 0, 255, 0.03) 1px, transparent 1px);
            --input-border: 1px solid #333;
        }

        [data-theme="ios"] {
            --color-bg-base: #f2f2f7;
            --color-bg-card: #ffffff;
            --color-bg-input: #f3f4f6;
            --color-text-main: #111827;
            --color-text-muted: #9ca3af;
            --color-accent: #007aff;
            --color-accent-hover: #0056b3;
            --color-border: #e5e7eb;
            --font-main: 'Inter', -apple-system, sans-serif;
            --font-display: 'Inter', -apple-system, sans-serif;
            --radius-theme: 16px;
            --shadow-theme: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --clip-path: none;
            --bg-pattern: none;
            --input-border: 1px solid transparent;
        }

        [data-theme="tactical"] {
            --color-bg-base: #1c1917;
            --color-bg-card: #292524;
            --color-bg-input: #0c0a09;
            --color-text-main: #e7e5e4;
            --color-text-muted: #78716c;
            --color-accent: #f97316;
            --color-accent-hover: #ea580c;
            --color-border: #44403c;
            --font-main: 'Roboto Mono', monospace;
            --font-display: 'Roboto Mono', monospace;
            --radius-theme: 2px;
            --shadow-theme: 4px 4px 0px 0px #0c0a09;
            --clip-path: none;
            --bg-pattern: repeating-linear-gradient(45deg, #292524 0, #292524 1px, transparent 0, transparent 50%);
            --input-border: 2px solid #44403c;
        }

        /* --- Base Styles --- */
        html {
            font-size: 100%;
            transition: font-size 0.2s ease;
        }

        body {
            background-color: var(--color-bg-base);
            color: var(--color-text-main);
            font-family: var(--font-main);
            background-image: var(--bg-pattern);
            background-size: 30px 30px;
            transition: background-color 0.3s, color 0.3s;
        }

        .theme-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-theme);
            border-radius: var(--radius-theme);
            clip-path: var(--clip-path);
            transition: all 0.3s ease;
        }

        .theme-input {
            background: var(--color-bg-input);
            border: var(--input-border);
            color: var(--color-text-main);
            border-radius: var(--radius-theme);
            transition: all 0.3s ease;
            min-height: 2.5rem; 
        }
        .theme-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(var(--color-accent), 0.2);
        }

        .theme-btn {
            background: var(--color-accent);
            color: var(--color-bg-base);
            border-radius: var(--radius-theme);
            transition: all 0.2s;
            font-weight: bold;
        }
        
        [data-theme="cyber"] .theme-btn { color: #000; box-shadow: 0 0 10px var(--color-accent); }
        [data-theme="ios"] .theme-btn { color: #fff; box-shadow: 0 4px 6px rgba(0,122,255,0.3); }
        [data-theme="tactical"] .theme-btn { color: #000; border: 1px solid #f97316; }

        .theme-btn:active {
            transform: scale(0.98);
            filter: brightness(0.9);
        }

        input[type="radio"]:checked + label {
            background-color: var(--color-accent);
            color: var(--color-bg-base); 
            border-color: var(--color-accent);
            font-weight: bold;
        }
        [data-theme="tactical"] input[type="radio"]:checked + label {
            background-color: rgba(249, 115, 22, 0.2);
            color: var(--color-accent);
            border: 2px solid var(--color-accent);
        }
        
        .toggle-checkbox:checked { right: 0; border-color: var(--color-accent); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--color-accent); }

        #fileInput { display: none; }
        
        /* Modal for Paste Restore */
        .modal-overlay {
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
        }
        
        * { transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <header class="p-4 border-b border-skin-border sticky top-0 z-50 backdrop-blur-md bg-skin-base/80">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-2xl font-display font-bold tracking-wider italic">
                <span class="text-skin-accent">OT</span> CALC <span class="text-xs not-italic text-skin-muted font-main">v2.03</span>
            </h1>
            <div class="flex gap-3 items-center">
                <!-- Font Size Controls -->
                <div class="flex items-center bg-skin-card border border-skin-border rounded-theme px-2 py-1 h-8">
                    <button onclick="adjustFontSize(-5)" class="text-skin-muted hover:text-skin-text px-2 h-full flex items-center justify-center active:scale-90 transition-transform" title="縮小字體">
                        <i class="fa-solid fa-minus text-xs"></i>
                    </button>
                    <span class="text-xs text-skin-muted mx-1 select-none font-bold">A</span>
                    <button onclick="adjustFontSize(5)" class="text-skin-muted hover:text-skin-text px-2 h-full flex items-center justify-center active:scale-90 transition-transform" title="放大字體">
                        <i class="fa-solid fa-plus text-xs"></i>
                    </button>
                </div>
                
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="text-skin-text hover:text-skin-accent transition-colors w-8 h-8 flex items-center justify-center" title="切換風格">
                    <i class="fa-solid fa-palette text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <section class="theme-card p-6 relative">
            <div class="absolute top-2 right-3 text-[10px] text-skin-muted font-display tracking-widest opacity-50">SYS.INPUT</div>
            
            <button id="btnQuickClockOut" class="w-full py-4 mb-6 theme-btn flex items-center justify-center gap-2 group uppercase tracking-widest font-display text-lg">
                <i class="fa-solid fa-fingerprint group-hover:scale-110 transition-transform"></i> 
                <span>一鍵下班</span>
            </button>

            <div class="mb-5 p-3 rounded-theme border border-skin-border bg-skin-input/50">
                <label class="block text-skin-accent text-xs font-bold mb-1 uppercase tracking-wide">
                    <i class="fa-solid fa-coins mr-1"></i>時薪 (Hourly Rate)
                </label>
                <div class="flex items-center">
                    <span class="text-skin-accent mr-2 text-lg">$</span>
                    <input type="number" id="hourlyRate" placeholder="輸入金額..." class="theme-input w-full p-2 text-lg font-main">
                </div>
                <div class="text-[10px] text-skin-muted mt-1 text-right">* 修改此欄位將連動計算總金額</div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="mb-5">
                    <label class="block text-skin-muted text-xs font-bold mb-2 uppercase tracking-wide">
                        <i class="fa-regular fa-calendar-days mr-2"></i>Date
                    </label>
                    <input type="date" id="workDate" class="theme-input w-full p-3 font-main text-base">
                </div>
                <div class="mb-5">
                    <label class="block text-skin-muted text-xs font-bold mb-2 uppercase tracking-wide">
                        <i class="fa-solid fa-briefcase mr-2"></i>Shift
                    </label>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <input type="radio" name="shift" id="shiftMorning" value="morning" class="hidden" checked>
                            <label for="shiftMorning" class="cursor-pointer block border border-skin-border rounded-theme p-3 text-center transition-all h-full flex items-center justify-center hover:bg-skin-accent/10">
                                <span class="font-bold text-lg font-main">早班</span>
                            </label>
                        </div>
                        <div class="flex-1">
                            <input type="radio" name="shift" id="shiftNight" value="night" class="hidden">
                            <label for="shiftNight" class="cursor-pointer block border border-skin-border rounded-theme p-3 text-center transition-all h-full flex items-center justify-center hover:bg-skin-accent/10">
                                <span class="font-bold text-lg font-main">晚班</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6 p-3 rounded-theme border border-skin-border bg-skin-input/50">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-skin-muted text-xs font-bold uppercase tracking-wide">
                        <i class="fa-solid fa-stopwatch mr-2"></i>加班時段 (Period)
                    </label>
                    <button onclick="resetStartTime()" class="text-[10px] text-skin-muted hover:text-skin-accent underline decoration-dotted">
                        重置
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <div class="text-[10px] text-skin-muted mb-1 text-center">Start</div>
                        <input type="time" id="startTime" class="theme-input w-full p-2 text-xl text-center font-main text-skin-accent">
                    </div>
                    <div class="text-skin-muted pt-5"><i class="fa-solid fa-arrow-right"></i></div>
                    <div class="flex-1">
                        <div class="text-[10px] text-skin-muted mb-1 text-center">End</div>
                        <input type="time" id="endTime" class="theme-input w-full p-2 text-xl text-center font-main" style="color: var(--color-accent-hover)">
                    </div>
                </div>
                <div class="text-right mt-1 h-4">
                     <span id="crossDayBadge" class="hidden text-[10px] bg-skin-accent text-skin-base px-1 rounded font-bold">NEXT DAY +1</span>
                </div>
            </div>

            <div class="bg-black/20 rounded-theme p-4 mb-6 border-l-4 border-skin-accent">
                <div class="flex justify-between items-end">
                    <div>
                        <div class="text-skin-muted text-[10px] uppercase mb-1">Estimated Pay (當次預估)</div>
                        <div id="previewPay" class="text-2xl text-skin-accent font-bold font-display">$0</div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold font-display text-skin-text" id="previewHours">0.0</div>
                        <div class="text-[10px] text-skin-accent uppercase">Hours Added</div>
                    </div>
                </div>
                <div id="statusText" class="text-right text-[10px] text-skin-muted mt-1">請輸入打卡時間</div>
            </div>

            <div class="flex items-center justify-end mb-3 gap-2">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="autoBackupToggle" class="sr-only peer">
                    <div class="relative w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-skin-accent"></div>
                    <span class="ms-2 text-xs text-skin-muted font-main">自動下載備份 (Auto-DL)</span>
                </label>
            </div>

            <button id="btnSave" class="w-full py-4 theme-btn font-display text-xl uppercase tracking-wider font-bold shadow-lg">
                Confirm & Save
            </button>
        </section>

        <section>
            <div class="flex justify-between items-end mb-4 px-1">
                <div>
                    <h2 class="text-skin-accent font-bold text-lg border-b-2 border-skin-accent px-1 inline-block font-display">HISTORY</h2>
                    <div class="text-skin-muted text-xs font-main mt-1">
                        Total: <span id="totalHours" class="text-skin-text font-bold">0.0</span> Hrs
                        <span class="mx-1">|</span>
                        <span id="totalMoney" class="text-skin-accent font-bold text-lg">$0</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <!-- Backup Group -->
                    <div class="flex rounded-theme border border-skin-border overflow-hidden">
                        <button onclick="exportData()" class="text-xs text-skin-muted px-3 py-1 hover:bg-skin-accent hover:text-skin-base transition-colors border-r border-skin-border" title="備份檔案">
                            <i class="fa-solid fa-file-export"></i> 備份
                        </button>
                        <button onclick="copyDataToClipboard()" class="text-xs text-skin-muted px-3 py-1 hover:bg-skin-accent hover:text-skin-base transition-colors" title="複製純文字">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                    
                    <!-- Restore Group -->
                    <div class="flex rounded-theme border border-skin-border overflow-hidden">
                        <button onclick="triggerImport()" class="text-xs text-skin-muted px-3 py-1 hover:bg-skin-accent hover:text-skin-base transition-colors border-r border-skin-border" title="還原檔案">
                            <i class="fa-solid fa-file-import"></i> 還原
                        </button>
                        <button onclick="openPasteModal()" class="text-xs text-skin-muted px-3 py-1 hover:bg-skin-accent hover:text-skin-base transition-colors" title="貼上純文字">
                            <i class="fa-regular fa-paste"></i>
                        </button>
                    </div>
                    <input type="file" id="fileInput" accept=".json" onchange="importData(this)">
                </div>
            </div>

            <div id="historyList" class="space-y-3 pb-10">
                <div class="text-center text-skin-muted py-8 font-main text-sm">No records found.</div>
            </div>

            <button onclick="clearAllData()" class="w-full text-xs text-skin-muted hover:text-red-500 mt-8 font-main border border-skin-border hover:border-red-500 p-2 rounded-theme transition-colors opacity-60 hover:opacity-100">
                [SYSTEM] CLEAR_MEMORY
            </button>
        </section>
    </main>

    <!-- Paste Restore Modal -->
    <div id="pasteModal" class="fixed inset-0 modal-overlay hidden z-[60] flex items-center justify-center p-4">
        <div class="theme-card w-full max-w-sm p-6 relative bg-skin-card">
            <h3 class="text-skin-accent font-bold font-display text-xl mb-4">TEXT RESTORE</h3>
            <textarea id="pasteInput" class="theme-input w-full h-32 p-3 font-mono text-xs mb-4" placeholder="請在此貼上備份代碼 (Paste backup code here)..."></textarea>
            <div class="flex gap-2">
                <button onclick="closePasteModal()" class="flex-1 py-2 border border-skin-border text-skin-muted rounded-theme font-bold">CANCEL</button>
                <button onclick="restoreFromPaste()" class="flex-1 py-2 theme-btn rounded-theme font-bold">IMPORT</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-skin-accent text-skin-base px-6 py-3 rounded-theme shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 z-50 font-bold tracking-wide text-sm whitespace-nowrap font-display">
        DATA SAVED
    </div>

    <script>
        // --- Font Size Manager ---
        let currentZoom = 100;
        
        function initFontSize() {
            const saved = localStorage.getItem('app_fontsize');
            if (saved) currentZoom = parseInt(saved);
            applyFontSize();
        }

        function adjustFontSize(delta) {
            currentZoom += delta;
            if (currentZoom < 80) currentZoom = 80; // Min limit
            if (currentZoom > 130) currentZoom = 130; // Max limit
            applyFontSize();
            localStorage.setItem('app_fontsize', currentZoom);
            showToastMessage(`Zoom: ${currentZoom}%`);
        }

        function applyFontSize() {
            document.documentElement.style.fontSize = `${currentZoom}%`;
        }

        // --- Theme Manager ---
        const THEMES = ['cyber', 'ios', 'tactical'];
        const THEME_NAMES = ['Cyberpunk', 'iOS Minimal', 'Tactical Ops'];
        let currentThemeIndex = 0;

        function initTheme() {
            const savedTheme = localStorage.getItem('app_theme');
            if (savedTheme && THEMES.includes(savedTheme)) {
                currentThemeIndex = THEMES.indexOf(savedTheme);
            }
            applyTheme();
        }

        function toggleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
            applyTheme();
            showToastMessage(`Switched to: ${THEME_NAMES[currentThemeIndex]}`);
        }

        function applyTheme() {
            const theme = THEMES[currentThemeIndex];
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('app_theme', theme);
        }

        // --- Config & Constants ---
        const STANDARD_MORNING_END = "17:30";
        const STANDARD_NIGHT_END = "03:00"; 
        const STORAGE_KEY = 'ot_history';
        const SETTING_AUTO_BACKUP = 'setting_auto_backup';
        const SETTING_HOURLY_RATE = 'setting_hourly_rate';
        
        // --- DOM Elements ---
        const elDate = document.getElementById('workDate');
        const elShiftMorning = document.getElementById('shiftMorning');
        const elShiftNight = document.getElementById('shiftNight');
        const elStartTime = document.getElementById('startTime');
        const elEndTime = document.getElementById('endTime');
        const elPreview = document.getElementById('previewHours');
        const elPreviewPay = document.getElementById('previewPay');
        const elHourlyRate = document.getElementById('hourlyRate');
        const elStatus = document.getElementById('statusText');
        const elSaveBtn = document.getElementById('btnSave');
        const elHistoryList = document.getElementById('historyList');
        const elTotalHours = document.getElementById('totalHours');
        const elTotalMoney = document.getElementById('totalMoney');
        const elToast = document.getElementById('toast');
        const elCrossDayBadge = document.getElementById('crossDayBadge');
        const elQuickBtn = document.getElementById('btnQuickClockOut');
        const elFileInput = document.getElementById('fileInput');
        const elAutoBackupToggle = document.getElementById('autoBackupToggle');
        const elPasteModal = document.getElementById('pasteModal');
        const elPasteInput = document.getElementById('pasteInput');

        let currentTotalHours = 0;

        // --- Init ---
        initFontSize();
        initTheme();
        elDate.valueAsDate = new Date();
        
        const savedAutoBackup = localStorage.getItem(SETTING_AUTO_BACKUP);
        elAutoBackupToggle.checked = savedAutoBackup === 'true';

        const savedRate = localStorage.getItem(SETTING_HOURLY_RATE);
        if(savedRate) elHourlyRate.value = savedRate;

        loadHistory();
        resetStartTime(); 

        // --- Event Listeners ---
        ['input', 'change', 'blur'].forEach(evt => {
            elEndTime.addEventListener(evt, updateCalculation);
            elStartTime.addEventListener(evt, updateCalculation);
            elHourlyRate.addEventListener(evt, updateCalculation);
        });
        
        elHourlyRate.addEventListener('input', () => {
             updateCalculation();
             updateTotalMoneyDisplay();
        });
        elHourlyRate.addEventListener('change', () => {
             localStorage.setItem(SETTING_HOURLY_RATE, elHourlyRate.value);
             updateTotalMoneyDisplay();
        });
        
        elShiftMorning.addEventListener('change', handleShiftChange);
        elShiftNight.addEventListener('change', handleShiftChange);
        elSaveBtn.addEventListener('click', saveRecord);
        elQuickBtn.addEventListener('click', quickClockOut);
        
        elAutoBackupToggle.addEventListener('change', () => {
            localStorage.setItem(SETTING_AUTO_BACKUP, elAutoBackupToggle.checked);
        });

        // --- Logic ---
        function quickClockOut() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;
            const h = now.getHours();
            let isMorning = true;
            if (h < 12) { isMorning = false; }
            if (isMorning) {
                elShiftMorning.checked = true;
                elDate.valueAsDate = now;
            } else {
                elShiftNight.checked = true;
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                elDate.valueAsDate = yesterday;
            }
            resetStartTime(); 
            elEndTime.value = timeStr; 
            updateCalculation();
            showToastMessage("已帶入現在時間");
        }

        function handleShiftChange() {
            resetStartTime();
            updateCalculation();
        }

        function resetStartTime() {
            const defaultTime = elShiftMorning.checked ? STANDARD_MORNING_END : STANDARD_NIGHT_END;
            elStartTime.value = defaultTime;
            updateCalculation();
        }

        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        function calculateDiffMinutes(startStr, endStr) {
            if (!startStr || !endStr) return 0;
            const startMins = timeToMinutes(startStr);
            const endMins = timeToMinutes(endStr);
            let diff = endMins - startMins;
            let isCrossDay = false;
            if (diff < 0) { diff += 1440; isCrossDay = true; }
            if (isCrossDay) { elCrossDayBadge.classList.remove('hidden'); } else { elCrossDayBadge.classList.add('hidden'); }
            return diff;
        }

        function calculateOvertimeHours(diffMinutes) {
            if (diffMinutes <= 0) return 0;
            const hours = Math.floor(diffMinutes / 60);
            const remainder = diffMinutes % 60;
            let extra = 0;
            if (remainder <= 20) extra = 0;
            else if (remainder <= 50) extra = 0.5;
            else extra = 1.0;
            return hours + extra;
        }

        function updateCalculation() {
            const startVal = elStartTime.value;
            const endVal = elEndTime.value;
            const rate = parseFloat(elHourlyRate.value) || 0;
            if (!endVal || !startVal) {
                elPreview.textContent = "0.0"; elPreviewPay.textContent = "$0"; elStatus.textContent = "Waiting for input..."; elCrossDayBadge.classList.add('hidden'); return;
            }
            const diff = calculateDiffMinutes(startVal, endVal);
            const ot = diff > 0 ? calculateOvertimeHours(diff) : 0;
            const pay = Math.round(ot * rate);
            elPreview.textContent = ot.toFixed(1);
            elPreviewPay.textContent = `$${pay.toLocaleString()}`;
            if (diff <= 0) {
                elStatus.textContent = `時數不足`; elStatus.className = "text-right text-[10px] text-skin-muted mt-1";
            } else {
                elStatus.innerHTML = `總計 <span class="text-skin-accent">${diff}</span> 分鐘`; elStatus.className = "text-right text-[10px] text-skin-muted mt-1";
            }
        }
        
        function updateTotalMoneyDisplay() {
            const rate = parseFloat(elHourlyRate.value) || 0;
            const totalMoney = Math.round(currentTotalHours * rate);
            elTotalMoney.textContent = `$${totalMoney.toLocaleString()}`;
        }

        async function saveRecord() {
            const date = elDate.value;
            const start = elStartTime.value;
            const end = elEndTime.value;
            const shift = elShiftMorning.checked ? '早班' : '晚班';
            const ot = parseFloat(elPreview.textContent);
            const rate = parseFloat(elHourlyRate.value) || 0;
            const pay = Math.round(ot * rate);
            if (!date || !start || !end) { alert("請完整填寫時間"); return; }
            const record = { id: Date.now(), date, timeRange: `${start} - ${end}`, shift, ot, rate, pay };
            let history = getHistoryFromStorage();
            history = history.filter(item => !(item.date === date && item.shift === shift));
            history.unshift(record);
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
                loadHistory();
                if (elAutoBackupToggle.checked) {
                    await exportData(true);
                    showToastMessage("SAVED"); 
                } else {
                    showToast();
                }
            } catch (e) { alert("儲存失敗"); }
        }

        function getHistoryFromStorage() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch (e) { return []; }
        }

        // Export Logic with Fix for "text.txt" - REMOVED 'text' property
        async function exportData(isAuto = false) {
            const data = getHistoryFromStorage();
            if (data.length === 0) { if(!isAuto) alert("無資料"); return; }
            
            const fileName = "OT_Backup.json";
            const file = new File([JSON.stringify(data)], fileName, {type: "application/json"});

            if (!isAuto && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file]
                        // Strictly NO title or text here to prevent iOS txt conversion
                    });
                    return; 
                } catch (err) {
                    console.log("Share failed or cancelled");
                }
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", fileName);
            document.body.appendChild(dlNode); 
            dlNode.click();
            dlNode.remove();
        }

        // Copy / Paste Logic
        function copyDataToClipboard() {
            const data = getHistoryFromStorage();
            if (data.length === 0) { alert("無資料"); return; }
            const str = JSON.stringify(data);
            
            // Clipboard API might be restricted in iframes or non-secure contexts, fallback to execCommand
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(str).then(() => showToastMessage("COPIED"));
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = str;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToastMessage("COPIED");
                } catch (err) {
                    alert("複製失敗");
                }
                document.body.removeChild(textArea);
            }
        }

        function openPasteModal() {
            elPasteInput.value = '';
            elPasteModal.classList.remove('hidden');
        }

        function closePasteModal() {
            elPasteModal.classList.add('hidden');
        }

        function restoreFromPaste() {
            const str = elPasteInput.value.trim();
            if(!str) return;
            
            try {
                const json = JSON.parse(str);
                if (Array.isArray(json)) {
                    if(confirm(`匯入 ${json.length} 筆資料？`)) {
                        const current = getHistoryFromStorage();
                        const merged = [...json, ...current];
                        const unique = Array.from(new Map(merged.map(item => [item.id, item])).values());
                        unique.sort((a, b) => b.id - a.id);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(unique));
                        loadHistory();
                        closePasteModal();
                        showToastMessage("匯入成功");
                    }
                } else { alert("格式錯誤"); }
            } catch(e) {
                alert("無效的資料格式");
            }
        }

        function triggerImport() { elFileInput.click(); }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        if(confirm(`匯入 ${json.length} 筆資料？(將合併現有資料)`)) {
                            const current = getHistoryFromStorage();
                            const merged = [...json, ...current];
                            const unique = Array.from(new Map(merged.map(item => [item.id, item])).values());
                            unique.sort((a, b) => b.id - a.id);
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(unique));
                            loadHistory();
                            showToastMessage("匯入成功");
                        }
                    } else { alert("格式錯誤"); }
                } catch (err) { alert("讀取失敗"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function deleteRecord(id) {
            if(!confirm("刪除此紀錄?")) return;
            let history = getHistoryFromStorage();
            history = history.filter(item => item.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            loadHistory();
        }

        function clearAllData() {
            if(confirm("警告：刪除所有紀錄？")) {
                localStorage.removeItem(STORAGE_KEY);
                loadHistory();
            }
        }

        function loadHistory() {
            const history = getHistoryFromStorage();
            elHistoryList.innerHTML = '';
            currentTotalHours = 0;
            if (history.length === 0) {
                elHistoryList.innerHTML = '<div class="text-center text-skin-muted py-8 font-main text-sm">[NO RECORDS]</div>';
            } else {
                history.forEach(item => {
                    currentTotalHours += item.ot;
                    const el = document.createElement('div');
                    const accentClass = item.shift === '早班' ? 'border-l-skin-accent' : 'border-l-skin-accent'; 
                    const icon = item.shift === '早班' ? '<i class="fa-regular fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
                    el.className = `theme-card p-3 flex justify-between items-center relative group border-l-4 ${accentClass}`;
                    el.innerHTML = `
                        <div>
                            <div class="text-xs text-skin-muted font-main mb-1">${item.date} <span class="ml-2">${icon} ${item.shift}</span></div>
                            <div class="text-skin-text font-bold text-base font-display">${item.timeRange || item.time}</div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <div class="text-2xl font-bold font-display text-skin-text">+${item.ot.toFixed(1)}</div>
                                <div class="text-[10px] text-skin-muted uppercase">Hours</div>
                            </div>
                            <button onclick="deleteRecord(${item.id})" class="text-skin-muted hover:text-red-500 transition-colors p-2"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    elHistoryList.appendChild(el);
                });
            }
            elTotalHours.textContent = currentTotalHours.toFixed(1);
            updateTotalMoneyDisplay();
        }

        function showToastMessage(msg) {
            elToast.textContent = msg;
            elToast.classList.remove('opacity-0');
            elToast.classList.add('opacity-100');
            setTimeout(() => {
                elToast.classList.remove('opacity-100');
                elToast.classList.add('opacity-0');
            }, 2000);
        }

        function showToast() { showToastMessage("DATA SAVED"); }

    </script>
</body>
</html>
